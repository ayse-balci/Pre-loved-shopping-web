<!------------Post Area-------------->    
<br><br><br><br>
<div>
    <form>

        <div class="form-group">
          <label for="main-title">İlan basligi</label>
          <input type="text" class="form-control" id="main-title" placeholder="Please write a title.">
        </div>


        <div class="form-group">
          <label for="main-desc">Aciklama</label>
          <input type="text" class="form-control" rows="3" id="main-desc" placeholder="Please write some description.">
        </div>



        <div class="form-row">
          <div class="form-group col-md-6">
            <label for="price">Price</label>
            <input type="number" class="form-control" id="price" data-bind="value:price">
          </div>


          <div class="form-group col-md-4">
            <label for="type-price">Type Of Money</label>
            <select id="type-price" class="form-control">
              <option selected>Choose...</option>
                <option value="0">$</option>
                <option value="1">dinar</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
            <div class="form-group col-md-6">
              <label for="metre-net">m² (net)</label>
              <input type="number" class="form-control" id="metre-net" >
            </div>
           
          </div>

          
          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="metre-brut">m² (brüt)</label>
              <input type="number" class="form-control" id="metre-brut" >
            </div>
           
          </div>

          <div class="form-row">
            <div class="form-group col-md-6">
                <label for="number-of-room">oda sayisi</label>
                <select id="number-of-room" class="form-control">
                <option selected>Choose...</option>
                <option value="value1+1">1+1</option>
                <option value="value2+1">2+1</option>
                <option value="value2+2">2+2</option>
                <option value="value3+1">3+1</option>
                <option value="value3+2">3+2</option>
                <option value="value4+1">4+1</option>
                <option value="value4+2">4+2</option>
                <option value="value5+1">5+1</option>
                <option value="value5+2">5+2</option>
                <option value="value5+">more...</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group col-md-6">
                <label for="age-of-building">bina yasi</label>
                <select id="age-of-building" class="form-control">
                <option selected>Choose...</option>
                <option value="0">0</option>
                <option value="0">1</option>
                <option value="0">2</option>
                <option value="0">3</option>
                <option value="0">4</option>
                <option value="0">5-10</option>
                <option value="0">11-15</option>
                <option value="0">16-20</option>
                <option value="0">21-25</option>
                <option value="0">26-30</option>
                <option value="0">more than 31</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group col-md-6">
                <label for="floor">bulundugu kat</label>
                <select id="floor" class="form-control">
                <option selected>Choose...</option>
                <option value="0">bodrum</option>
                <option value="0">zemin</option>
                <option value="0">1</option>
                <option value="0">2</option>
                <option value="0">3</option>
                <option value="0">4</option>
                <option value="0">5</option>
                <option value="0">6</option>
                <option value="0">7</option>
                <option value="0">8</option>
                <option value="0">9</option>
                <option value="0">10</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group col-md-6">
                <label for="number-of-floors">kat sayisi</label>
                <select id="number-of-floors" class="form-control">
                <option selected>Choose...</option>
                <option value="0">1</option>
                <option value="0">2</option>
                <option value="0">3</option>
                <option value="0">4</option>
                <option value="0">5</option>
                <option value="0">6</option>
                <option value="0">7</option>
                <option value="0">8</option>
                <option value="0">9</option>
                <option value="0">10</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group col-md-6">
                <label for="number-of-bathroom">banyo sayisi</label>
                <select id="number-of-bathroom" class="form-control">
                <option selected>Choose...</option>
                <option value="0">None</option>
                <option value="0">1</option>
                <option value="0">2</option>
                <option value="0">3</option>
                <option value="0">4</option>
                <option value="0">5</option>
                <option value="0">6</option>
                <option value="0">more than 6</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group col-md-6">
                <label for="balkony">balkon</label>
                <select id="balkony" class="form-control">
                <option selected>Choose...</option>
                <option value="0">yes</option>
                <option value="0">no</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="gridCheck">
              <label class="form-check-label" for="gridCheck">
                Esyali
              </label>
            </div>
          </div>

          
          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="inputCity">City</label>
              <input type="text" class="form-control" id="inputCity">
            </div>
            <div class="form-group col-md-4">
              <label for="inputState">State</label>
              <select id="inputState" class="form-control">
                <option selected>Choose...</option>
                <option>...</option>
              </select>
            </div>
            
          </div>

          <div class="form-group">
            <label for="inputAddress">Address</label>
            <input type="text" class="form-control" id="inputAddress" placeholder="1234 Main St">
          </div>


        <br><br>
        <div class="form-group"> 
            <input type="file" class="form-control" id="main-image"/>
            <div class="invalid-feedback">
                Please choose a valid picture.
            </div>
        </div>
        <div class="form-group">
            <img id="selected-image" width="250" height="150" src="#" />
        </div>

        <div class="form-group">
            <div class="progress bg-secondary">
                <div class="progress-bar bg-success" id="upload-progress" style="width: 0%">0%</div>
            </div>
        </div>

        <div class="form-group">
            <button id="save-post" type="button" style="width: 150px; height: 60px;" class="btn btn-light bg-light text-dark">Post</button>
        </div>

      </form>

<!----------------------Post Area Ends-------------->    


<!----------------------Validation and uploading of posts-------------->  

<script>
    var validImagetypes = ["image-gif", "image/jpeg", "image/png", "image/jpg"];

    $("#selected-image").hide();

    function previewImage(image_post) 
    {
       if (image_post.files && image_post.files[0])
       {
        var reader = new FileReader();

            reader.onload = function(e) {
                $("#selected-image").attr('src', e.target.result);
                $("#selected-image").fadeIn;                        
            }

            reader.readAsDataURL(image_post.files[0]);

            $("#selected-image").show();
       }
    }

    

    $("#main-image").change(function() 
    {
        previewImage(this);
    });

    $("#save-post").click(function() 
    {
        $("#main-title").removeClass("is-invalid");
        $("#main-desc").removeClass("is-invalid");    
        
        $("#price").removeClass("is-invalid");
        
        
        $("#metre-net").removeClass("is-invalid");
        $("#metre-brut").removeClass("is-invalid");

        $("#number-of-room").removeClass("is-invalid");
        $("#age-of-building").removeClass("is-invalid");
        $("#floor").removeClass("is-invalid");
        $("#number-of-floors").removeClass("is-invalid");
        $("#number-of-bathroom").removeClass("is-invalid");
        $("#balkony").removeClass("is-invalid");

        var desc = $("#main-desc").val();
        var title = $("#main-title").val();
        var price = $("#price").val();
        var metre_net = $("#metre-net").val();
        var metre_brut = $("#metre-brut").val();
        var numberOfRooms = $("#number-of-room option:selected").text();
        var ageOfBuilding = $("#age-of-building option:selected").text();
        var floor = $("#floor option:selected").text();
        var numberOfFloors = $("#number-of-floors option:selected").text();
        var numberOfBathroom = $("#number-of-bathroom option:selected").text();
        var balkony = $("#balkony option:selected").text();

       

        var picture_post = $("#main-image").prop("files")[0];

        if (!desc) 
        {
            $("#main-desc").addClass("is-invalid");
            return;
        }
        if (!title) 
        {
            $("#main-title").addClass("is-invalid");
            return;
        }
        if (!price) 
        {
            $("#price").addClass("is-invalid");
            return;
        }
        if (!metre_net) 
        {
            $("#metre-net").addClass("is-invalid");
            return;
        }
        if (!metre_brut) 
        {
            $("#metre-brut").addClass("is-invalid");
            return;
        }
        if (!numberOfRooms) 
        {
            $("#number-of-room").addClass("is-invalid");
            return;
        }
        if (!ageOfBuilding) 
        {
            $("#age-of-building").addClass("is-invalid");
            return;
        }
        if (!floor) 
        {
            $("#floor").addClass("is-invalid");
            return;
        }
        if (!numberOfFloors) 
        {
            $("#number-of-floors").addClass("is-invalid");
            return;
        }
        if (!numberOfBathroom) 
        {
            $("#number-of-bathroom").addClass("is-invalid");
            return;
        }
        if (!balkony) 
        {
            $("#balkony").addClass("is-invalid");
            return;
        }
        if (picture_post == null)
        {
            $("#main-image").addClass("is-invalid");
            return;
        }


        if ($.inArray(picture_post["type"], validImagetypes) < 0) 
        {
            $("#main-image").addClass("is-invalid");
            return;
        }

        //**************************Upload and Save to Firebase Storage & Database****************************//

        var databaseRef = firebase.database().ref().child("Materials");

        databaseRef.once("value").then(function(snapshot) 
        {
            var name = picture_post["name"];
            var dateStr = new Date().getTime();
            var fileCompleteName = name + "_" + dateStr;

            var storageRef = firebase.storage().ref("Post Images");
            var blogStorageRef = storageRef.child(fileCompleteName);

            var uploadTask = blogStorageRef.put(picture_post);

            uploadTask.on("state_changed", 

                function progress(snapshot) 
                {
                    var percentage = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                
                    $("#upload-progress").html(Math.round(percentage) + "%");
                    $("#upload-progress").attr("style", "width:" + percentage + "%");
                },

                function error(err) 
                {

                },

                function complete() 
                {
                    var user = firebase.auth().currentUser;
                    var userName;
                    firebase.database().ref('Users/' + user.uid).once('value').then(function(snapshot) 
                    {
                        var fName = (snapshot.val() && snapshot.val().firstName);
                        var sName = (snapshot.val() && snapshot.val().secondName);
                   
                        userName = fName + " " + sName;

                    });

                    uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL)
                    {
                        var time = new Date();

                        var options = {
                            weekday: "long",
                            month: "long",
                            day: "2-digit",
                            year: "numeric",
                        };

                        var postData = 
                        {
                            "generalType": "House",
                            "type": "Daire",
                            "title": title,
                            "desc" : desc, 

                            "price" : price,
                            "metre_net" : metre_net,
                            "metre_brut" : metre_brut,

                            "number_of_rooms" : numberOfRooms,
                            "age_of_building" : ageOfBuilding,
                            "floor" : floor,
                            "number_of_floors" : numberOfFloors,
                            "number_of_bathroom" : numberOfBathroom,
                            "balkony" : balkony,


                            "image" : downloadURL,
                            "name" : fileCompleteName,
                            
                            "uid" : user.uid,
                            "nameOfUser" : userName,
                            "time" : time.toLocaleString('en-US', {hour: 'numeric' , minute : 'numeric' ,hour12:true }),
                            "date" : time.toLocaleDateString('en-US', options),
                        };

                        var newPostRef = databaseRef.push();

                        newPostRef.set(postData, function(err)
                        {
                            if (err) 
                            {
                                $("#result").attr("class", "alert alert-danger");
                                $("#result").html(err.message);
                                
                            } else {
                                $("#result").attr("class", "alert alert-success");
                                $("#result").html("Post has been uploaded successfully.");
                            
                                window.open("", "_self");
                            }
                            resetForm();
                        });
                    });
                }

            );

        });



        //**************************Upload and Save to Firebase Storage & Database Ends****************************//
        
    });

    function resetForm() 
    {
        $("#main-form")[0].reset();
        $("#selected-image").fadeOut("slow");
        $("#upload-progress").html("Completed");
         
    }



</script>

<!----------------------Validation and uploading of posts Ends-------------->  
